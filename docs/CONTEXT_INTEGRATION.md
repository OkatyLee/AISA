# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ —Å–∏—Å—Ç–µ–º—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ë—ã–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É:

1. **–ü–æ–º–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞** - —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
2. **–ü–æ–Ω–∏–º–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã** - –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–µ—â–µ —Å—Ç–∞—Ç—å–∏" –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. **–û–±—ä–µ–¥–∏–Ω—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é** - –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. **–£–ª—É—á—à–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–π** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. ContextManager (`nlp/context_manager.py`)
- –£–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã

### 2. QueryProcessor (–æ–±–Ω–æ–≤–ª–µ–Ω)
- –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `UserContext` –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
- –£–ª—É—á—à–∞–µ—Ç –≤—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –û–±–æ–≥–∞—â–∞–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

### 3. IntentClassifier (—É–ª—É—á—à–µ–Ω)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
  - "–µ—â–µ —Å—Ç–∞—Ç—å–∏", "–±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
  - "–æ—Ç –∞–≤—Ç–æ—Ä–∞", "–∑–∞ –≥–æ–¥"
  - "–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ", "—Ç–∞–∫–∂–µ"
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π
- –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–∞–º–µ—Ä–µ–Ω–∏–π

### 4. MessageHandler (–æ–±–Ω–æ–≤–ª–µ–Ω)
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å ContextManager
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–≤–µ—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

## –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
```
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–∞–π–¥–∏ —Å—Ç–∞—Ç—å–∏ –ø—Ä–æ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ"
ü§ñ –ë–æ—Ç: [–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞]

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–µ—â–µ —Å—Ç–∞—Ç—å–∏"  
ü§ñ –ë–æ—Ç: [–ü–æ–Ω–∏–º–∞–µ—Ç: "–µ—â–µ —Å—Ç–∞—Ç—å–∏ –ø—Ä–æ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ"]

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–æ—Ç –∞–≤—Ç–æ—Ä–∞ Smith"
ü§ñ –ë–æ—Ç: [–ü–æ–Ω–∏–º–∞–µ—Ç: "—Å—Ç–∞—Ç—å–∏ –ø—Ä–æ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –æ—Ç –∞–≤—Ç–æ—Ä–∞ Smith"]
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–º–µ–Ω–∞ —Ç–µ–º—ã
```
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–∞–π–¥–∏ —Å—Ç–∞—Ç—å–∏ –ø—Ä–æ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ"
ü§ñ –ë–æ—Ç: [–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –º–∞—à–∏–Ω–Ω–æ–º—É –æ–±—É—á–µ–Ω–∏—é]

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–∞–π–¥–∏ —Å—Ç–∞—Ç—å–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏"
ü§ñ –ë–æ—Ç: [–ù–æ–≤–∞—è —Ç–µ–º–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ]

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"
ü§ñ –ë–æ—Ç: [–ü–æ–Ω–∏–º–∞–µ—Ç: "–±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ–Ω–Ω—ã–µ —Å–µ—Ç–∏"]
```

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –û–±–æ–≥–∞—â–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
```python
def _enrich_entities_from_context(self, entities, context, intent):
    if intent.intent == Intent.SEARCH:
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–º—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        if not has_topic and context.current_topic:
            topic_entity = Entity(
                type=EntityType.TOPIC,
                value=context.current_topic,
                confidence=0.7  # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
            )
            entities.entities.append(topic_entity)
```

### –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞–º–µ—Ä–µ–Ω–∏–π
```python
def classify(self, text: str, context_intent: Intent = None):
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–æ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç
    if not scores and context_intent and len(text.split()) <= 5:
        if context_intent == Intent.SEARCH:
            scores[Intent.SEARCH] = 0.3  # –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞
```

### –£–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
```python
def _enhance_with_context(self, text: str, context: UserContext):
    # –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ–º—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    if len(text.split()) <= 3 and context.current_topic:
        if any(word in text.lower() for word in ['–µ—â–µ', '–±–æ–ª—å—à–µ', '—Ç–∞–∫–∂–µ']):
            text = f"{text} –ø–æ {context.current_topic}"
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### UserContext
- `user_id`: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `conversation_history`: –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ (ConversationTurn)
- `current_topic`: –¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è —Ç–µ–º–∞
- `user_preferences`: –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `last_search_results`: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞

### ConversationTurn
- `timestamp`: –í—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è
- `user_message`: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `intent`: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
- `entities`: –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
- `bot_response`: –û—Ç–≤–µ—Ç –±–æ—Ç–∞
- `search_results`: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç—ã:
- `test_simple_context.py` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- `test_context_integration.py` - –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—è:
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –û–±–æ–≥–∞—â–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é –Ω–∞–º–µ—Ä–µ–Ω–∏–π
- ‚úÖ –°–º–µ–Ω—É —Ç–µ–º –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –æ–±—â–∞—Ç—å—Å—è –∫–∞–∫ —Å —á–µ–ª–æ–≤–µ–∫–æ–º
2. **–≠–∫–æ–Ω–æ–º–∏—è —Å–ª–æ–≤** - –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
3. **–£–º–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ** - –±–æ—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –º–µ—Å—Ç–æ–∏–º–µ–Ω–∏—è –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã
4. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** - –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
5. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–¢–µ–ø–µ—Ä—å –±–æ—Ç –º–æ–∂–µ—Ç –≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–µ –¥–∏–∞–ª–æ–≥–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –ø–æ–º–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø–æ–Ω–∏–º–∞—è –Ω–µ–ø–æ–ª–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã!
